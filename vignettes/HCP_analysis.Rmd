---
title: "Human Connectome Project Analysis"
author: "Shael Brown and Dr. Reza Farivar"
output: 
  rmarkdown::html_document:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Human Connectome Project Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: REFERENCES.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# get original graphic parameters to be able to
# revert back at the end of the vignette
original_mfrow <- par()$mfrow
original_xpd <- par()$xpd
original_mar <- par()$mar
original_scipen <- options()$scipen
if(exists(".Random.seed", .GlobalEnv) == F)
{
  runif(1)
}
oldseed <- get(".Random.seed", .GlobalEnv)
oldRNGkind <- RNGkind()

# set some new parameters for viewing and reproducibility
options(scipen = 999)
set.seed(123)
par(mfrow = c(1,1))
```

# Introduction

A popular technology for studying neural function is called functional magnetic resonance imaging (fMRI), in which oxygenated blood-flow is detected via magnetic resonance, across the brain over multiple time points, as a proxy measurement of neural activity. Spatial activity patterns, i.e. vectors of measured values across space in a single time point, are modulated by performing tasks (the "study" design is the sequence of temporal "blocks" of performing these tasks, and each task type is called a "condition") and can therefore encode meaningful information about neural processing. Collections of spatial activity patterns, for example the spatial patterns evoked by a particular task over multiple time points, have previously been analyzed with (topological) techniques which capture their global structural features [@brain_manifold;@BrainOrganizationMapper;@fMRI_clustering_2;@resting_state_mapper]. However, these analyses are not designed to capture the (spatially) periodic features of fMRI data which we would expect to exist in abundance [@fMRI_noise1;@fMRI_noise2;@Denoising]. One persistent homology analysis of fMRI spatial pattern data found robust 0-dimensional topological features (i.e. clusters of time points with similar spatial patterns) whose persistence values negatively correlated with fluid intelligence [@topological_time_and_space] (i.e. larger differences between spatial patterns at different time points generally corresponded to lower values of fluid intelligence), but higher-dimensional topological features like loops were not considered in that analysis.

In this exploratory analysis, using **TDApplied**, we used persistent homology to find task-related signal in one subject's fMRI data in an emotion task, which formed a spatial loop. We then linked the loop back to the subject's raw data to interpret what (neurological) features the loop represented, and finally we showed that topological features in 100 subject's emotion task fMRI data were correlated with behavior (i.e. the subject's response time to certain task blocks). While neuroimaging researchers would not consider a single loop within one subject "real" or "significant" without finding a similar loop across multiple subjects, the task of optimally matching loops between datasets is an open problem, so we leave the problem of finding group-level spatial loops to future work. For our analysis we will use data from the famous Human Connectome Project [@HCP] which contains extensively preprocessed neuroimaging data from roughly 1200 subjects. We focused on the HCP emotion task data, which alternated between two conditions - deciding which of two faces matched another target face in emotion, and deciding which of two shapes matched another target shape. We only analyzed the right-to-left phase encoding scan (this is a parameter of MRI imaging which determines the ordering of when image slices of the brain are obtained) as this was the phase encoding direction for the specific subject loop we analyzed. Also, all fMRI data was projected onto surface nodes -- points, on a mesh of the brain's surface geometry, which are more comparable across subjects than standard 3D volumes [@HCP]. The script used to generate the analysis results, as well as the subject ID's used, can be found in the exec directory of **TDApplied**. Our analysis demonstrates the potential of using **TDApplied** for deriving interpretable and otherwise obscured insights from real datasets.

# A task-related spatial loop

For HCP subject 103111 we calculated a persistence diagram by analyzing the time-point by time-point correlation matrix $[\rho_{i,j}]$ of spatial patterns. A distance matrix was computed by the transformation $\rho_{i,j} \rightarrow \sqrt{2*(1 - \rho_{i,j})}$ (see the appendix for details), and the bootstrap procedure found a single significant loop. We plotted the VR graph of the loop representative at its birth scale (with nodes labelled by their time points), and the VR graph of the whole dataset at the scale of the loop birth (with nodes in the representative cycle colored red):

```{r,echo = F,out.width="60%", out.height="60%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("rips_cycle.png","rips_all.png"))
```

Two things are apparent from these plots - the first is that the most persistent loop is the first task block (based on the time points in that block), and the second is that the dataset mainly forms two major loops in a figure eight. The secondary loop was the second most persistent loop in the diagram, and was comprised of (almost) all other time points. We found that physiology (i.e. breathing, measured in the HCP dataset) did not account for the two-loop structure, whereas task structure (measured by time-since-last-block - i.e. the length of time since the most recent task block started) did. In the following plots, blue colors indicates low values, white middle values, red high values and black indicates missing values:

```{r,echo = F,out.width="60%", out.height="60%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("rips_respiratory.png","rips_task.png"))
```

The secondary loop seemed task related when we colored its VR graph by time-since-last-block (i.e. the length of time since the most recent task block started), with clusters of similarly-colored time points (i.e. nodes) and smooth gradients at various points around the loop:

```{r,echo = F,out.width="60%", out.height="60%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("rips_secondary.png"))
```

# Linking the secondary loop to raw data

We next linked the secondary loop back to the fMRI data from which it came. From the 2D layout of its VR graph we computed a $\theta$ variable (angle around the loop, between $-\pi$ and $\pi$) and an $r$ variable (distance to the origin). Using linear models of the form $A_i = \beta_{1}\cos(\theta) + \beta_{2}\sin(\theta) + \beta_3$ and $A_i = \beta_{4}r + \beta_5$ for the activity $A$ of surface node $i$, we found that out of the total 91282 surface nodes, the activity of 1475 had a significant relationship with either $\cos(\theta)$ or $\sin(\theta)$, and the activity of 53 had a significant relationship with $r$ (significance thresholding was done at the Bonferroni level of approximately $2.74*10^{-7}$). These two sets of nodes only shared one common node. 

Here are surface plots of the nodes for the left hemisphere, generated using python, responding to $\theta$ (top) and $r$ (bottom):

```{r,echo = F,out.width="40%", out.height="40%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("theta_nodes.png"))
knitr::include_graphics(c("r_nodes.png"))
```

A large cluster of surface nodes responding to $\theta$ was found in the left hemisphere (and not in the right hemisphere), which appeared to belong to the brain region Pol1 in the insular cortex. Interestingly, Pol1 was not found to show significant differences in activity between the faces and shapes conditions [@HCP_multimodal_parcellation], despite the implication of the insular cortex in emotional processing [@insula], suggesting that spatial loops of fMRI data may contain complementary information to typical task-based analyses of fMRI data. 

In order to make the variable $\theta$ more interpretable, we plotted the (normalized) activity of nodes responding to $\theta$ around the loop (which we represented as an idealized unit circle, although the loop does not form a perfect unit circle in the data): 

```{r,echo = F,out.width="60%", out.height="60%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("theta_activity.png"))
```

The activity of the large cluster seemed to be low from the bottom of the loop through the top right, and high from the top of the left through the bottom left. A similar plot would have been possible for different values of $r$, along a single straight-line axis, however with so few nodes we found that the plot was unclear. A t-test then found a significant difference in mean $r$ values between shape and face blocks:

```{r,echo = F,out.width="40%", out.height="40%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("r_boxplot.png"))
```

# Linking topology to behavior

The main goal of a summary statistic of neurological data, like persistence diagrams of spatial activity patterns, is to correlate with behavior. In the HCP dataset, mean reaction time (in milliseconds) was recorded for all subjects and all tasks, so we checked whether topology was predictive of reaction time for the emotion task. We selected 100 subjects at random, computed their emotion right-to-left phase encoding data persistence diagrams, and computed a two dimensional kernel PCA embedding. We plotted the embedding scatterplot (top), colored by mean reaction time to shape condition blocks (more intense red means larger response time), and the relationship between the first embedding dimension and reaction time (bottom):

```{r,echo = F,out.width="40%", out.height="40%",fig.show="hold",fig.align = 'center'}
knitr::include_graphics(c("pca_2_dims.png"))
knitr::include_graphics(c("topology_behavior.png"))
```

We found that there was a positive correlation between topological similarities and response time similarities, thereby relating the persistence diagrams to human behavior.

# Conclusion

We analyzed spatial loops in HCP emotion fMRI data using **TDApplied**, and were able to visualize and interpret the large-scale spatial loops of an individual subject, relating them to the study design. Moreover, we were able to find a topology-behavior relationship in which topological similarities between subjects were informative of reaction time to shape condition blocks. These results point towards the potential usage of high (above 0) dimensional topology in finding task-related and behavior-related summaries of fMRI spatial patterns.

# Appendix: Converting Correlations to Distances

In our analysis of HCP data we converted correlation values to correlation distance values using the formula $\rho \rightarrow \sqrt{2*(1-\rho)}$. To see why this transformation does produce distance values, let $X$ and $Y$ be two vectors (of the same length $n$) with 0 mean and unit variance. Then $\rho(X,Y) = \frac{Cov(E,Y)}{\sigma_{x}\sigma_{y}} = \frac{E[(X-0)(Y-0)]}{(1)(1)} = E[XY] = \frac{\sum_{i = 1}^{n}X_i Y_i}{n}$. The Euclidean distance of $X$ and $Y$ is therefore $d(X,Y) = \sqrt{\sum_{i=1}^{n}(X_i-Y_i)^2} = \sqrt{\sum_{i=1}^{n}X_i^2 + \sum_{i=1}^{n}Y_i^2 -2\sum_{i=1}^{n}X_i Y_i} = \sqrt{n + n - 2\rho(X,Y)} = \sqrt{2n(1-\rho(X,Y))} \propto \sqrt{2(1-\rho(X,Y))}$. Therefore, since a scaled distance metric (by a positive number like $\sqrt{n}$) is also a distance metric (this is very easy to verify), the transformation $\rho \rightarrow \sqrt{2*(1-\rho)}$ indeed gives distance values. Note that in [@topological_time_and_space] a proportional transformation was used $\rho \rightarrow \sqrt{1-\rho} \propto \sqrt{2(1-\rho)}$ and therefore our results are consistent with those found in that work.

```{r,echo = F}
# reset parameters
par(mfrow = original_mfrow,xpd = original_xpd,mar = original_mar)
options(scipen = original_scipen)
do.call("RNGkind",as.list(oldRNGkind))
assign(".Random.seed", oldseed, .GlobalEnv)
```

## References
